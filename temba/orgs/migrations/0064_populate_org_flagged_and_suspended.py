# Generated by Django 2.2.4 on 2020-06-16 17:14

from django.db import migrations, transaction

BATCH_SIZE = 5000


def populate_org_suspended_and_flagged(apps, schema_editor):
    Org = apps.get_model("orgs", "Org")
    orgs = Org.objects.all()

    num_updated = 0
    max_id = -1
    while True:
        batch = list(orgs.filter(id__gt=max_id).order_by("id")[:BATCH_SIZE])
        if not batch:
            break

        with transaction.atomic():
            for org in batch:
                org.plan = "topups"
                org.is_suspended = False
                org.is_flagged = org.config.get("status") == "suspended"
                org.save(update_fields=("plan", "is_suspended", "is_flagged"))

        num_updated += len(batch)
        print(f" > Updated {num_updated} orgs")

        max_id = batch[-1].id


def reverse(apps, schema_editor):  # pragma: no cover
    pass


def apply_manual():  # pragma: no cover
    from django.apps import apps

    populate_org_suspended_and_flagged(apps, None)


class Migration(migrations.Migration):

    dependencies = [
        ("orgs", "0063_auto_20200616_1624"),
    ]

    operations = [migrations.RunPython(populate_org_suspended_and_flagged, reverse)]
