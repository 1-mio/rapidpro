-extends "smartmin/list.html"

-load smartmin temba compress humanize channels
-load i18n tz


-block fields

-block title
  .medium-help.float-left(class='{{ ticketer.get_type.icon }}')

  %h2.font_normalize.header-margin.title
    {{ ticketer.get_type.name }}
    -trans "Ticketing Service"
    .name
      {{ ticketer.name }}

  .header-margin
    %a.btn.btn-tiny(href="{% url 'request_logs.httplog_list' 'ticketer' ticketer.uuid %}")
      -trans "Ticketing Service Log"

-block content
  %h3
    -trans "Active Tickets"

  %table.list-table.table.table-bordered.table-striped.table-condensed.message-stats-table
    %thead
      %tr
        %th
          -trans "Contact"
        %th
          -trans "Subject"
        %th
          -trans "Body"
        %th
          -trans "Created On"
        %th

    %tbody
      -for ticket in object_list
        %tr
          %td.ticket-contact
            %a(href="{% url 'contacts.contact_read' ticket.contact.uuid %}")
              {{ ticket.contact }}
          %td.ticket-subject
            {{ ticket.subject }}
          %td.ticket-body
            {{ ticket.body }}
          %td.ticket-opened
            {{ ticket.opened_on }}
          %td.ticket-actions
            -if org_perms.tickets.ticket_close
              %a(href="#" onclick='closeTicket("{{ ticket.uuid }}")')
                -trans "Close"

        -empty
          %tr.empty
            %td(colspan=4)
              -trans "No open tickets at this time."

-block post-content
  - if org_perms.tickets.ticketer_delete
    .deletion.hide
      .title
        -trans "Delete Ticketing Service"
      .body
        %p
          -trans "Once it is removed, it will be gone forever. There is no way to undo this operation."

    %a#deletion-form.posterize{href:'{% url "tickets.ticketer_delete" ticketer.uuid %}'}

-block extra-script
  {{ block.super }}

  :javascript
    $(".delete-ticketer").live('click', function(){
    {% if used_by_flows %}
      var modal = new Modal("{% trans 'Warning' %}", '{% trans "Unable to delete service still being used by flows" %}');
      modal.addClass('alert');
      modal.setListeners({onPrimary: function(){modal.dismiss();}}, false);
      modal.show();
    {% else %}
      var modal = new ConfirmationModal($('.deletion > .title').html(), $('.deletion > .body').html());
      modal.addClass('alert');
      modal.setListeners({onPrimary: function(){
        $('#deletion-form').click();
      }}, false);
      modal.setPrimaryButton('{% trans "Delete" %}');
      modal.show();
    {% endif %}
    });

    function closeTicket(uuid) {
      // TODO
      alert("TODO close ticket " + uuid);
    }

-block extra-style
  {{ block.super }}

  :css
    td {
      padding: 5px;
    }

    td.ticket-id {
      font-family: monospace;
      width: 400px;
    }

    td.ticket-opened {
      width: 200px;
    }

    .name {
      font-size: 16pt;
    }


-block summary
  {{ object.get_type.name }}
  -trans "Ticketing Service"
  %span -
  %strong
    {{ ticketer.name }}
