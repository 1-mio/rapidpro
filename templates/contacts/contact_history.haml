-load contacts humanize smartmin temba i18n

-for item in activity

  -ifchanged
    -if item.msg_type == 'V'
      -with item.steps.all.first.run.call as call
        %tr{class:'end-call'}
          %td{colspan:'3'}
            Call ended
            -with call.duration|format_seconds as duration
              -if duration
                ({{duration}})

            <!--{{call.pk}}-->

  %tr.item{class:'msg_{{item.msg_type}} {% if item.direction or item.recipient_count%}msg{%else%}non-msg hide{%endif%}'}
    %td.created_on
      {{item.created_on}}

    %td.icon

      -if item.recording_url
        .recording{onClick:'playMessage("{{item.pk}}");'}
          %audio{id:'message-{{item.pk}}', type:"audio/wav", src:'{{item.recording_url}}'}
          .play
            .icon-phone{title:'{{item.channel.get_channel_type_name}} {{item.channel.get_name}}'}
          .stop.hide
            .icon-nav-channels-inverted
      -else
        %span.det{title:'{{item.channel.get_channel_type_name}} {{item.channel.get_name}}'}
          {{item|activity_icon}}

    %td.details
      -if item.recipient_count
        -with item as broadcast
          .activity-broadcast
            .sent-to
              .summary
                Broadcast to {{broadcast.recipient_count|intcomma}} recipients

            .activity-body
              {{broadcast.text}}
      -elif item.call_type
        -with item as call
          Phone call ({{call.duration|format_seconds}})
          -for run in call.runs.all
            {{run}}
            -for msg in run.messages
              .msg
                {{msg}}

      -elif item.flow
        -with item as run
          .activity-run
            .activity-body
              .summary

              Started
              %a{href:'{% url "flows.flow_editor" run.flow.pk%}'}
                {{run.flow.name}}
      -elif item.fired
        -with item as eventfire
          %a{href:'{%url "campaigns.campaign_read" eventfire.event.campaign.pk %}'}><
            {{eventfire.event.campaign.name}}

          &nbsp;triggered

          %a{href:'{%url "campaigns.campaignevent_read" eventfire.event.pk %}'}
            {{eventfire.event|event_time}}


      -else
        -with item as message

          .activity-message
            -if message.direction == 'O'

              -if message.broadcast.recipient_count > 1
                .sent-to
                  .summary
                    Broadcast to {{message.broadcast.recipient_count|intcomma}} recipients
              .summary

                -with message.get_flow_id as flow_id
                  -if flow_id
                    //Message from
                    //%a{href:'{% url "flows.flow_editor" flow_id %}'}
                    //  {{message.get_flow_name}}

            .activity-body
              .text
                -if message.text == message.recording_url

                  .left-recording
                    Made a recording
                -else
                  {{message.text}}



%tr.since
  %td{colspan:3}

    %span.date
      Activity since {{start_time}}
    %p
      %a.btn.btn-tiny.btn-secondary.load-more
        Load More